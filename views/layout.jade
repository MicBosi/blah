doctype html
html
    head
        title #{title}
        link(rel='stylesheet', href='/bootstrap/css/bootstrap.min.css')
        script(src='/javascripts/jquery-2.1.4.min.js')
        script(src='/javascripts/underscore-min.js')
        script(src='/bootstrap/js/bootstrap.min.js')
        script(src='/socket.io/socket.io.js')
        link(rel='stylesheet', href='/stylesheets/style.css')

    script.
            var seen_messages = new Set();
            var socket = io.connect('http://localhost:3000');
            socket.on('append-messages', function (data) {
                // counter = data.count;
                var messages = $('#messages')[0];
                data.new_messages.forEach(function(msg_data) {
                    if (!seen_messages.has(msg_data._id)) {
                        seen_messages.add(msg_data._id)
                        var p = document.createElement('p');
                        var date = new Date(msg_data.time);
                        var date_string = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                        var template = _.template("<blockquote><p>(<%= _id %>) <b><%= author %></b>: <%= message %></p><footer><%= date_string %></footer></blockquote>");
                        $(p).html(template({
                            _id: msg_data._id,
                            author: msg_data.author,
                            message: msg_data.message,
                            date_string: date_string
                        }));
                        // $(p).html(msg_data._id + ': ' + msg_data.message + '<br><footer>' + date_string + '</footer>');
                        messages.insertBefore(p, messages.firstChild);
                    }
                });
            });
            socket.on('post-message-ok', function(data) {
                $('#message')[0].value = '';
                $('#message')[0].readOnly = false;
            });
            function sendMessage() {
                $('#message')[0].readOnly = true;
                var message = $('#message')[0].value;
                socket.emit('post-message', {
                    message: message
                });
            }
    body
        block content
